伙伴系统分配器 - PF_MEMALLOC 标志位

这是一个进程标记位，除了在内存管理子系统中使用外，还在其他的内核子系统中使用。之所以在伙伴系统分配器中讨论，是因为这个标记和内存管理密不可分。

当一个进程被设置PF_MEMALLOC后，那么对进程会有如下影响：

1. 当进程进行页面分配时，可以忽略内存管理的水印进行分配，这是告诉内存管理系统，给我一点紧急内存使用，我将会释放更多的内存给你。

2. 如果忽略水印分配仍然失败，那么直接返回ENOMEM，而不是等待kswapd回收或者缩减内存

3. 如果忽略水印分配仍然失败，那么直接返回ENOMEM，而不会调用OOM killer去杀死进程，释放内存

4. 2和3 说的很清楚了，就是在page_allocs中失败并不会重试。


PF_MEMALLOC含义：
当前进程有很多可以释放的内存，如果能分配一点紧急内存给当前进程，那么当前进程可以返回更多的内存给系统。非内存管理子系统不应该使用这个标记，除非这次分配保证会释放更大的内存给系统。如果每个子系统都滥用这个标记，可能会耗尽内存管理子系统的保留内存。


虽然这个标志的引入，是为了内存管理系统在紧急情况下使用，但是却被其他的内核子系统滥用，一个日本人为此曾提了7个patch来修复这些滥用的代码。

http://lkml.indiana.edu/hypermail/linux/kernel/0911.2/00576.html


不过，在我使用的内核版本2.6.34，仍然可以看到其他子系统使用PF_MEMALLOC，具体case要具体分析了。